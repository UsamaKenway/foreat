{% extends 'base.html' %}

{% block content %}
<div class="space-y-6">
    <!-- Header & Actions -->
    <div class="bg-white shadow px-4 py-5 sm:rounded-lg sm:p-6 flex justify-between items-center">
        <div>
            <h2 class="text-lg leading-6 font-medium text-gray-900">Training & Forecast Hub</h2>
            <p class="mt-1 text-sm text-gray-500">Train models on your sales data and view predictions.</p>
        </div>
        <div>
            <button id="train-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                Start New Training Run
            </button>
        </div>
    </div>

    <!-- Metrics Grid -->
    <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-3">
        {% for run in runs %}
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <dt class="text-sm font-medium text-gray-500 truncate">Run {{ run.id }} ({{ run.training_date|date:"M d, H:i" }})</dt>
                <dd class="mt-1 text-2xl font-semibold text-gray-900">MAE: {{ run.metric_mae|floatformat:2 }}</dd>
                <dd class="mt-1 text-sm text-gray-500">MAPE: {{ run.metric_mape|floatformat:4 }}</dd>
            </div>
        </div>
        {% empty %}
        <div class="bg-white overflow-hidden shadow rounded-lg col-span-3">
            <div class="px-4 py-5 sm:p-6 text-center text-gray-500">
                No training runs yet. Click "Start New Training Run".
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Forecast Chart -->
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Sales Forecast (Next 14 Days)</h3>
        <div id="forecast-chart" style="width:100%;height:400px;"></div>
    </div>

    <!-- Ingredient Needs -->
    <div class="bg-white shadow rounded-lg overflow-hidden">
        <div class="px-4 py-5 sm:px-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Projected Ingredient Requirements</h3>
            <p class="mt-1 max-w-2xl text-sm text-gray-500">Based on forecasted sales and BOMs.</p>
        </div>
        <div class="border-t border-gray-200">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ingredient</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Required Quantity</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for item in ingredient_needs %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ item.ingredient }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ item.qty|floatformat:2 }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ item.unit }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3" class="px-6 py-4 text-center text-gray-500">No predictions available to calculate ingredients.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
    // Chart Logic
    const predictions = JSON.parse('{{ predictions_json|escapejs }}');
    
    if (predictions.length > 0) {
        // Group by Item
        const items = [...new Set(predictions.map(p => p.item))];
        const data = [];
        
        items.forEach(item => {
            const itemPreds = predictions.filter(p => p.item === item);
            data.push({
                x: itemPreds.map(p => p.date),
                y: itemPreds.map(p => p.qty),
                type: 'scatter',
                mode: 'lines+markers',
                name: item
            });
        });

        Plotly.newPlot('forecast-chart', data, {
            title: 'Predicted Sales Volume',
            xaxis: {title: 'Date'},
            yaxis: {title: 'Quantity Sold'},
            margin: {t: 30}
        });
    } else {
        document.getElementById('forecast-chart').innerHTML = '<p class="text-center text-gray-500 py-10">No forecast data available.</p>';
    }

    // Training Button Logic
    document.getElementById('train-btn').addEventListener('click', function() {
        const btn = this;
        btn.disabled = true;
        btn.innerHTML = 'Training...';
        btn.classList.add('opacity-50');
        
        fetch('{% url "train_model" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}' # CSRF is actually handled by cookie usually but let's try this
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Training complete! MAE: ' + data.mae.toFixed(2));
                location.reload();
            } else {
                alert('Error: ' + data.message);
                btn.disabled = false;
                btn.innerHTML = 'Start New Training Run';
                btn.classList.remove('opacity-50');
            }
        })
        .catch(err => {
            alert('Request failed.');
            console.error(err);
            btn.disabled = false;
            btn.innerHTML = 'Start New Training Run';
            btn.classList.remove('opacity-50');
        });
    });
</script>
{% endblock %}
